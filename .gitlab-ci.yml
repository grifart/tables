stages:
  - install
  - test

install.php80:
  stage: install
  image: grifart/php8.0-with-all-modules-and-various-tools
  interruptible: true
  script:
    - composer install
  artifacts:
    paths:
      - vendor/
    expire_in: 1 day

install.php81:
  extends: install.php80
  image: grifart/php8.1-with-all-modules-and-various-tools

install.php-next:
  extends: install.php80
  allow_failure: true
  script:
    - composer install --ignore-platform-reqs
  image: grifart/php-next

phpstan:
  stage: test
  image: grifart/php8.1-with-all-modules-and-various-tools
  interruptible: true
  dependencies:
    - install.php81
  script:
    - composer run phpstan

tests.php80:
  stage: test
  image: grifart/php8.0-with-all-modules-and-various-tools
  interruptible: true
  dependencies:
    - install.php80
  services:
    - postgres:14-alpine
  variables:
    POSTGRES_DB: tables
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
  before_script:
    - mv tests/createConnection.ci.php tests/createConnection.local.php
    - php tests/initializeDatabase.php
  script:
    - composer run test

tests.php81:
  extends: tests.php80
  image: grifart/php8.1-with-all-modules-and-various-tools
  dependencies:
    - install.php81

tests.php-next:
  extends: tests.php80
  image: grifart/php-next
  allow_failure: true
  dependencies:
    - install.php-next
